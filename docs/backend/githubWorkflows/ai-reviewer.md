# AI SOP Reviewer Workflow

## Overview

The **AI SOP Reviewer** is a GitHub Actions workflow that automatically reviews pull requests against your repositoryâ€™s standard operating procedures (SOPs). It leverages OpenAI to analyze changed files, detect potential violations, and suggest inline fixes. A summary of findings is posted as a comment on the pull request.

This workflow ensures code quality and SOP compliance without manual review, saving time and maintaining consistency across the codebase.

---

## Features

* Reviews code changes in pull requests automatically.
* Skips certain file types (`.yml`, `.yaml`, `.json`, `.md`) and scripts in `SysScripts/`.
* Suggests inline fixes directly in the code for easy integration.
* Posts a detailed summary in the PR with detected issues and recommended fixes.
* Uses a strict JSON format to structure AI outputs for consistency.

---

## Workflow Trigger

The workflow is triggered on the following pull request events:

```yaml
on:
  pull_request:
    types: [opened, synchronize, reopened]
```

* `opened` â†’ When a PR is created.
* `synchronize` â†’ When the branch is updated.
* `reopened` â†’ When a PR is reopened.

---

## Permissions

The workflow requires the following GitHub permissions:

```yaml
permissions:
  contents: read          # Read repository files
  pull-requests: write    # Add comments to PRs
  issues: write           # Post PR review summaries as comments
```

---

## Setup and Dependencies

The workflow uses Node.js and the following packages:

* `openai` â†’ For AI-powered SOP analysis.
* `@octokit/rest` â†’ To interact with GitHub APIs.
* `fs` & `path` â†’ To handle local files.

Dependencies are installed with:

```bash
npm install openai @octokit/rest
```

---

## Environment Variables

Two secrets are required in your repository:

* `OPENAI_API_KEY` â†’ API key for OpenAI.
* `GITHUB_TOKEN` â†’ Token to post comments and interact with the repository.

These are accessed in the workflow via `${{ secrets.OPENAI_API_KEY }}` and `${{ secrets.GITHUB_TOKEN }}`.

---

## How It Works

1. **Checkout Repository**
   The workflow checks out the PR branch locally using `actions/checkout@v4`.

2. **Read SOP File**
   It reads `Review_Prompt.md` containing the rules for SOP compliance.

3. **Get Changed Files**
   The workflow retrieves the list of files changed in the pull request.

4. **Filter Files**
   Certain file types or paths are skipped to avoid unnecessary reviews.

5. **AI Review**
   Each file is sent to OpenAI with the SOP rules. The AI responds with JSON containing:

   * `line`: Line number with an issue.
   * `issue`: Short description of the problem.
   * `fix`: One-line suggested fix.

6. **Inline Comments**
   Detected issues are appended as inline comments in the local file copy.

7. **Summary Comment**
   A structured summary of all issues is posted as a comment in the pull request.

---

## Customization

### 1. SOP Rules

Edit `Review_Prompt.md` to define the coding standards and SOP rules. Example:

```markdown
- No console.log in production code
- Variable names must follow camelCase
- Functions must have JSDoc comments
```

### 2. File Filtering

Update the file skipping logic in `review.js`:

```js
if (
  filePath.endsWith(".yml") ||
  filePath.endsWith(".json") ||
  filePath.includes("SysScripts/")
) {
  continue;
}
```

### 3. AI Model

You can change the OpenAI model in `review.js`:

```js
const response = await openai.chat.completions.create({
  model: "gpt-4o-mini",
  messages: [{ role: "user", content: prompt }],
  temperature: 0,
});
```

* `gpt-4o-mini` â†’ Fast and cost-efficient.
* `gpt-4.1` â†’ Higher accuracy but slower.

### 4. Output Format

The AI must respond in strict JSON:

```json
[
  {
    "line": 42,
    "issue": "Variable not camelCase",
    "fix": "Rename variable to camelCase"
  }
]
```

---

## Adding the Workflow

1. Create `.github/workflows/ai_sop_review.yml`.
2. Paste the workflow YAML into this file.
3. Ensure `review.js` exists at `Services/SysScripts/AgentScripts/review.js`.
4. Commit and push the workflow.
5. Add `OPENAI_API_KEY` and `GITHUB_TOKEN` as repository secrets.

---

## Usage

1. Open or update a pull request.
2. The workflow runs automatically.
3. Review the PR comment generated by the AI for any SOP violations.
4. Apply fixes manually or accept the inline suggestions.

---

## Tips

* Keep `Review_Prompt.md` up to date with new coding standards.
* Adjust `temperature` in OpenAI requests for deterministic outputs (`0` for stable results).
* For large PRs, consider splitting into smaller PRs to avoid long AI processing times.
* You can extend the workflow to auto-create commits with AI-suggested fixes if desired.

---

## Example PR Comment

```markdown
## ðŸ¤– AI SOP Review Summary
Automated review detected potential issues according to `Review_Prompt.md`.

### ðŸ§¾ File: `Services/Utils/math.js`
- Line 12: Variable name not camelCase â†’ **Fix:** Rename variable to camelCase
- Line 45: Missing function documentation â†’ **Fix:** Add JSDoc comment

> _This is an AI-assisted compliance review. Please verify fixes before merging._
```

